---
layout: post
title: "ASP.NET 6 应用Docker部署"
date: 2021-09-17 00:00
comments: true
toc: true
tags:
  - 2021-09
  - C#
  - ASP.NET 6
  - Docker
  - 教程
---

Linux环境简单部署ASP.NET 6应用到Docker容器

<!--more-->

---
首先创建一个用于存放源码的文件夹。
``` bash
$ mkdir test
$ cd test
```

然后在当前文件夹中初始化一个ASP.NET 6的测试项目。（如果不知道关键字，可通过输出dotnet new -l查询所有可以创建的项目的类型）
``` bash
$ dotnet new web
```
![运行结果](/assets/blogImg/DP-210917-01.png)

接下来执行dotnet run查看效果
``` bash
$ dotnet run
```
![运行结果](/assets/blogImg/DP-210917-02.png)

![前端页面](/assets/blogImg/DP-210917-03.png)


helloworld应用创建完成后，开始为其制作Dockerfile。
该程序的运行环境为ASP.NET Core 6，本教程采用微软官方的alpine3.14镜像，其[Dockerfile](https://github.com/dotnet/dotnet-docker/blob/aabe56522d8cf3c17df84f78928f2b4bb33b9425/src/aspnet/6.0/alpine3.14/amd64/Dockerfile)的内容如下所示。如有其它需求，也可以到[Docker Hub 微软官方发布的镜像库](https://hub.docker.com/_/microsoft-dotnet-aspnet)中获取。

``` dockerfile
ARG REPO=mcr.microsoft.com/dotnet/runtime
FROM $REPO:6.0.0-rc.2-alpine3.14-arm32v7

# .NET globalization APIs will use invariant mode by default because DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=true is set
# by the base runtime-deps image. See https://aka.ms/dotnet-globalization-alpine-containers for more information.

ENV \
    # ASP.NET Core version
    ASPNET_VERSION=6.0.0-rc.2.21480.10 \
    # Set the default console formatter to JSON
    Logging__Console__FormatterName=Json

# Install ASP.NET Core
RUN wget -O aspnetcore.tar.gz https://dotnetcli.azureedge.net/dotnet/aspnetcore/Runtime/$ASPNET_VERSION/aspnetcore-runtime-$ASPNET_VERSION-linux-musl-arm.tar.gz \
    && aspnetcore_sha512='8fde5df285a852cfa37bc026983357cac8fdc77c5f9e2fdb242f1c967375e43bac9cc6f9ac6caa684a9bb3aab94c0f98ff93e8e9650399b44917c9e51d8e545c' \
    && echo "$aspnetcore_sha512  aspnetcore.tar.gz" | sha512sum -c - \
    && tar -ozxf aspnetcore.tar.gz -C /usr/share/dotnet ./shared/Microsoft.AspNetCore.App \
    && rm aspnetcore.tar.gz
```

本演示项目对原始Dockerfile文件做了些许修改，完整Dockerfile内容如下：
``` dockerfile
ARG REPO=mcr.microsoft.com/dotnet/runtime
FROM $REPO:6.0.0-rc.1-alpine3.14-amd64

# .NET globalization APIs will use invariant mode by default because DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=true is set
# by the base runtime-deps image. See https://aka.ms/dotnet-globalization-alpine-containers for more information.

ENV \
    # ASP.NET Core version
    ASPNET_VERSION=6.0.0-rc.1.21452.15 \
    # Set the default console formatter to JSON
    Logging__Console__FormatterName=Json

# Install ASP.NET Core
RUN wget -O aspnetcore.tar.gz https://dotnetcli.azureedge.net/dotnet/aspnetcore/Runtime/$ASPNET_VERSION/aspnetcore-runtime-$ASPNET_VERSION-linux-musl-x64.tar.gz \
    && aspnetcore_sha512='c34e939169faafd9ffc2189695f7e5e134170b131850606c781b80801aab3f8b73a6c4bdb0dbe9b104b065e0585339deec97da367662ed0cf1f0e7dcd009cee1' \
    && echo "$aspnetcore_sha512  aspnetcore.tar.gz" | sha512sum -c - \
    && tar -ozxf aspnetcore.tar.gz -C /usr/share/dotnet ./shared/Microsoft.AspNetCore.App \
    && rm aspnetcore.tar.gz \
    && mkdir /lib64 \
    && ln -s /lib/libc.musl-x86_64.so.1 /lib64/ld-linux-x86-64.so.2

# Work dir
WORKDIR /app

# Copy project files to work dir
COPY ./ ./

# Set expose port
EXPOSE 80/tcp

# Application entry point
ENTRYPOINT ["dotnet", "webhello.dll"]
```

演示项目在调试过程中，提示某个依赖项不存在，因此本人在原始Dockerfile的基础上增加了一个指向替代依赖项的软链接。

除此之外，我还设定了程序的工作路径，并且追加了将源码复制到docker镜像中的命令，设置了容器的监听端口(80)，程序的入口(ENTRYPOINT)。

完整的Dockerfile内容如下所示，仅供参考：
``` dockerfile
ARG REPO=mcr.microsoft.com/dotnet/runtime
FROM $REPO:6.0.0-rc.1-alpine3.14-amd64

# .NET globalization APIs will use invariant mode by default because DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=true is set
# by the base runtime-deps image. See https://aka.ms/dotnet-globalization-alpine-containers for more information.

ENV \
    # ASP.NET Core version
    ASPNET_VERSION=6.0.0-rc.1.21452.15 \
    # Set the default console formatter to JSON
    Logging__Console__FormatterName=Json

# Install ASP.NET Core
RUN wget -O aspnetcore.tar.gz https://dotnetcli.azureedge.net/dotnet/aspnetcore/Runtime/$ASPNET_VERSION/aspnetcore-runtime-$ASPNET_VERSION-linux-musl-x64.tar.gz \
    && aspnetcore_sha512='c34e939169faafd9ffc2189695f7e5e134170b131850606c781b80801aab3f8b73a6c4bdb0dbe9b104b065e0585339deec97da367662ed0cf1f0e7dcd009cee1' \
    && echo "$aspnetcore_sha512  aspnetcore.tar.gz" | sha512sum -c - \
    && tar -ozxf aspnetcore.tar.gz -C /usr/share/dotnet ./shared/Microsoft.AspNetCore.App \
    && rm aspnetcore.tar.gz \
    && mkdir /lib64 \
    && ln -s /lib/libc.musl-x86_64.so.1 /lib64/ld-linux-x86-64.so.2

# Work dir
WORKDIR /app

# Copy project files to work dir
COPY ./ ./

# Set expose port
EXPOSE 80/tcp

# Application entry point
ENTRYPOINT ["dotnet", "webhello.dll"]
```

Dockerfile配置完成后就可以进行镜像打包和发布了。Docker镜像打包发布参考请其他教程。

以上演示项目已上传到Github：https://github.com/XVCoder/webhello ，Docker镜像(xv132/dothello)也已上传到[Docker Hub](https://hub.docker.com/repository/docker/xv132/dothello)，有需要者自取。